<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Focus Reminder Prototype</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f5f5f7;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        header {
            background: #007bff;
            color: white;
            width: 100%;
            padding: 1.2rem;
            text-align: center;
            font-size: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        main {
            width: 100%;
            max-width: 600px;
            margin-top: 2rem;
            padding: 0 1rem;
        }
        form {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        form.minimized {
            height: 40px; /* or whatever small height you want */
            display: flex;
            justify-content: center; /* horizontal center */
            align-items: center;     /* vertical center */
            cursor: pointer;
            overflow: hidden;
            padding: 0;
        }
        
        form.minimized > *:not(#minimizedPlaceholder) {
            display: none; /* hide everything else when minimized */
        }
        
        #minimizedPlaceholder {
            display: block;
            font-weight: bold;
            color: #007bff;
            font-size: 1rem;
        }
        
        
        form.minimized:hover {
            background: #eef4ff;
        }
        form input, form button, form textarea {
            padding: 0.6rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }
        form button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }
        form button:hover { background: #0056b3; }
        label { font-weight: 600; font-size: 0.9rem; }
        
        .task-list { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .task { perspective: 1000px; }
        .task-inner { position: relative; width: 100%; min-height: 160px; border-radius: 10px; transform-style: preserve-3d; transition: transform 0.6s; }
        .task-inner.flipped { transform: rotateY(180deg); }
        
        .task-front, .task-back {
            position: absolute;
            inset: 0;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            backface-visibility: hidden;
            box-sizing: border-box;
        }
        
        .task-front { justify-content: space-between; }
        .task-back {
            background:white;
            transform: rotateY(180deg);
            justify-content: space-between;
            align-items: center;
            text-align: center;
            font-size: 1rem;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
        }
        
        .priority-badge { position: absolute; top: 6px; right: 10px; font-weight: bold; font-size: 2rem; color: white; border-radius: 8px; padding: 4px 12px; min-width: 40px; text-align: center; z-index: 2; }
        .task h3 { margin:0; font-size:1.2rem; }
        .task small { color:#666; display:block; }
        .task .due { font-weight:600; }
        
        .task .delete {
            align-self:flex-end;
            background:#007bff;
            color:white;
            border:none;
            border-radius:6px;
            padding:0.3rem 0.6rem;
            cursor:pointer;
            font-size:0.9rem;
        }
        .task .delete:hover { background:#0056b3; }
        
        .empty { text-align:center; color:#777; margin-top:2rem; }
        
        .urgency-container { display:flex; gap:8px; margin-top:5px; flex-wrap:wrap; }
        .urgency-circle { width: 32px; height: 32px; border: 2px solid #888; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; user-select: none; transition: background 0.3s, color 0.3s; }
        .urgency-circle.selected { color:white; }
        
        @keyframes pulseGlow { 0% { box-shadow:0 0 6px rgba(255,0,0,0.3); } 50% { box-shadow:0 0 20px rgba(255,0,0,0.9); } 100% { box-shadow:0 0 6px rgba(255,0,0,0.3); } }
        .glow { animation: pulseGlow 1s infinite ease-in-out; }
        
        .sort-controls { text-align:center; margin-top:1rem; display:flex; justify-content:center; align-items:center; gap:0.5rem; }
        .sort-controls select { padding:0.4rem; border-radius:6px; border:1px solid #ccc; font-size:0.9rem; }
        .sort-button { border:none; background:none; font-size:1.1rem; cursor:pointer; color:#007bff; transition:0.2s; }
        .sort-button:hover { color:#0056b3; }
        
        .urgency-color { height:6px; border-radius:3px; width: calc(100% - 60px); z-index:1; }
        
        .edit-desc-btn { align-self:flex-end; background: #28a745; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .edit-desc-btn:hover { background: #218838; }
        
        .minimize-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            align-self: flex-end;
            font-size: 0.9rem;
        }
        .task-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center; /* vertically centers the label and button */
        }
        
        
        
        .minimize-btn:hover { background: #5a6268; }
    </style>
</head>
<body>
    <!--  <header>ðŸ§  Focus Reminder</header>  -->
    <div id="authSection" style="margin-top: 2rem;">
        <h2>Login / Sign Up</h2>
        <input type="email" id="emailInput" placeholder="Email" required />
        <input type="password" id="passwordInput" placeholder="Password" required />
        <button id="signupBtn">Sign Up</button>
        <button id="loginBtn">Log In</button>
        <button id="guestBtn">Continue as Guest</button>
        <button id="logoutBtn" style="display:none;">Log Out</button>
    </div>
    
    
    <main>
        <form id="taskForm">
            <div id="minimizedPlaceholder" style="display:none; text-align:center; font-weight:bold; color:#007bff;">New Task</div>
            
            <div class="task-form-header">
                <label for="taskTitle">Task</label>
                <button type="button" id="minimizeBtn" class="minimize-btn">â€“</button>
            </div>
            
            <input type="text" id="taskTitle" placeholder="Task name..." required />
            <label for="taskDueDate">Due Date (optional)</label>
            <input type="date" id="taskDueDate" />
            <div class="time-toggle">
                <input type="checkbox" id="addTimeToggle" />
                <label for="addTimeToggle">Add specific time</label>
            </div>
            <input type="time" id="taskDueTime" style="display:none" />
            <div class="desc-toggle">
                <input type="checkbox" id="addDescToggle" />
                <label for="addDescToggle">Add description</label>
            </div>
            <textarea id="taskDesc" placeholder="Description..." style="display:none" maxlength="275"></textarea>
            <label>Priority</label>
            <div class="urgency-container" id="urgencyContainer"></div>
            <input type="hidden" id="taskUrgency" />
            <button type="submit">Add Task</button>
        </form>
        
        <div class="sort-controls">
            <label for="sortOption">Sort by:</label>
            <select id="sortOption">
                <option value="dueDate">Due Date</option>
                <option value="urgency">Priority</option>
            </select>
            <button id="sortOrderBtn" class="sort-button">â†“</button>
        </div>
        
        <div class="task-list" id="taskList"></div>
    </main>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyArb6pfC5kzKkKsbL5bym1aQNVohz-1Q9k",
            authDomain: "reminder-25e05.firebaseapp.com",
            projectId: "reminder-25e05",
            storageBucket: "reminder-25e05.firebasestorage.app",
            messagingSenderId: "23989997139",
            appId: "1:23989997139:web:382235c98a4cadc5c5c0a6"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOM elements
        const signupBtn = document.getElementById("signupBtn");
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        // Guest login button
        const guestBtn = document.createElement("button");
        guestBtn.textContent = "Continue as Guest";
        guestBtn.id = "guestBtn";
        guestBtn.style.marginTop = "0.5rem";
        guestBtn.addEventListener("click", async () => {
            try {
                const userCred = await signInAnonymously(auth);
                currentUser = userCred.user;
                alert("Logged in as guest!");
                loadUserTasks(currentUser.uid);
            } catch (e) {
                alert("Could not log in as guest: " + e.message);
            }
        });
        document.getElementById("authSection").appendChild(guestBtn);
        
        const emailInput = document.getElementById("emailInput");
        const passwordInput = document.getElementById("passwordInput");
        const form = document.getElementById("taskForm");
        const minimizeBtn = document.getElementById("minimizeBtn");
        const taskList = document.getElementById("taskList");
        const addTimeToggle = document.getElementById("addTimeToggle");
        const timeInput = document.getElementById("taskDueTime");
        const addDescToggle = document.getElementById("addDescToggle");
        const descInput = document.getElementById("taskDesc");
        const urgencyContainer = document.getElementById("urgencyContainer");
        const hiddenInput = document.getElementById("taskUrgency");
        const sortOption = document.getElementById("sortOption");
        const sortOrderBtn = document.getElementById("sortOrderBtn");
        
        let tasks = [];
        let sortAscending = false;
        let currentUser = null;
        
        // Load saved form state
        const savedMinimized = localStorage.getItem("taskFormMinimized");
        if(savedMinimized === "true") {
            form.classList.add("minimized");
            minimizeBtn.textContent = "+";
            minimizedPlaceholder.style.display = "block"; // <-- add this line
        } else {
            form.classList.remove("minimized");
            minimizeBtn.textContent = "â€“";
            minimizedPlaceholder.style.display = "none";  // <-- ensure hidden
        }
        
        
        
        // Firebase Auth
        signupBtn.addEventListener("click", async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            try { await createUserWithEmailAndPassword(auth,email,password); alert("Account created!"); } 
            catch(e){ alert(e.message); }
        });
        
        loginBtn.addEventListener("click", async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            try { await signInWithEmailAndPassword(auth,email,password); alert("Logged in!"); } 
            catch(e){ alert(e.message); }
        });
        
        logoutBtn.addEventListener("click", async () => {
            await signOut(auth);
            alert("Logged out!");
        });
        
        onAuthStateChanged(auth, (user) => {
            const authSection = document.getElementById("authSection");
            if (user) {
                currentUser = user;
                
                // Show only the logout button in the top right
                authSection.innerHTML = `
            <button id="logoutBtn" class="minimize-btn" style="position:absolute; top:10px; right:10px;">Log Out</button>
        `;
                
                document.getElementById("logoutBtn").addEventListener("click", async () => {
                    await signOut(auth);
                    alert("Logged out!");
                    location.reload();
                });
                
                loadUserTasks(user.uid);
                
            } else {
                currentUser = null;
                tasks = [];
                taskList.innerHTML = `<p class="empty">Please log in to see your tasks.</p>`;
                
                // Restore all login options including guest
                authSection.innerHTML = `
            <h2>Login / Sign Up</h2>
            <input type="email" id="emailInput" placeholder="Email" required />
            <input type="password" id="passwordInput" placeholder="Password" required />
            <button id="signupBtn">Sign Up</button>
            <button id="loginBtn">Log In</button>
            <button id="guestBtn">Continue as Guest</button>
            <button id="logoutBtn" style="display:none;">Log Out</button>
        `;
                
                // Re-attach event listeners
                document.getElementById("signupBtn").addEventListener("click", async () => {
                    const email = document.getElementById("emailInput").value;
                    const password = document.getElementById("passwordInput").value;
                    try { await createUserWithEmailAndPassword(auth,email,password); alert("Account created!"); } 
                    catch(e){ alert(e.message); }
                });
                
                document.getElementById("loginBtn").addEventListener("click", async () => {
                    const email = document.getElementById("emailInput").value;
                    const password = document.getElementById("passwordInput").value;
                    try { await signInWithEmailAndPassword(auth,email,password); alert("Logged in!"); } 
                    catch(e){ alert(e.message); }
                });
                
                document.getElementById("guestBtn").addEventListener("click", async () => {
                    try {
                        const userCredential = await signInAnonymously(auth);
                        currentUser = userCredential.user;
                        alert("Logged in as Guest!");
                        loadUserTasks(currentUser.uid);
                    } catch (e) {
                        console.error("Anonymous login failed:", e);
                        alert("Could not log in as guest.");
                    }
                });
            }
        });
        
        
        
        // Firestore functions
        async function saveTaskToFirestore(userId, task){
            try{ await addDoc(collection(db,"users",userId,"tasks"),task); }
            catch(e){ console.error("Error saving task:", e); }
        }
        
        async function loadUserTasks(userId){
            try{
                const q=query(collection(db,"users",userId,"tasks"));
                const querySnapshot=await getDocs(q);
                tasks=[];
                querySnapshot.forEach(docSnap=>{ tasks.push({id:docSnap.id,...docSnap.data()}); });
                renderTasks();
            } catch(e){ console.error("Error loading tasks:",e); }
        }
        
        async function deleteTaskFromFirestore(userId, taskId){
            try{ await deleteDoc(doc(db,"users",userId,"tasks",taskId)); } 
            catch(e){ console.error("Error deleting task:",e); }
        }
        
        async function updateTaskDesc(userId, taskId, newDesc){
            try{ await updateDoc(doc(db,"users",userId,"tasks",taskId),{desc:newDesc}); } 
            catch(e){ console.error("Error updating description:",e); }
        }
        
        // Minimize form
        minimizeBtn.addEventListener("click", e => { 
            e.stopPropagation();
            form.classList.toggle("minimized");
            const minimized = form.classList.contains("minimized");
            minimizeBtn.textContent = minimized ? "+" : "â€“";
            minimizedPlaceholder.style.display = minimized ? "block" : "none";
            // save state
            localStorage.setItem("taskFormMinimized", form.classList.contains("minimized") ? "true" : "false");
        });
        form.addEventListener("click", e => {
            if(form.classList.contains("minimized")){
                form.classList.remove("minimized");
                minimizeBtn.textContent = "â€“";
                minimizedPlaceholder.style.display = "none";
            }
        });
        
        
        form.addEventListener("click", e=>{ if(form.classList.contains("minimized")){ form.classList.remove("minimized"); minimizeBtn.textContent="â€“"; } });
        
        // Priorities
        const priorities=["!","!!","!!!"];
        
        urgencyContainer.innerHTML="";
        priorities.forEach(p=>{
            const circle=document.createElement("div");
            circle.className="urgency-circle";
            circle.textContent=p;
            circle.dataset.value=p;
            urgencyContainer.appendChild(circle);
        });
        urgencyContainer.addEventListener("click", e => {
            if (!e.target.classList.contains("urgency-circle")) return;
            
            const clickedValue = e.target.dataset.value;
            
            // Map priorities to colors
            const priorityColors = {
                "!": "#ff9999",    // light red
                "!!": "#ff4d4d",   // medium red
                "!!!": "#990000"   // dark red
            };
            const defaultBorderColor = "#007bff";
            
            // If the clicked priority is already selected, deselect it
            if (hiddenInput.value === clickedValue) {
                hiddenInput.value = ""; // clear priority
                document.querySelectorAll(".urgency-circle").forEach(c => {
                    c.style.background = "";
                    c.style.color = "";
                    c.classList.remove("selected");
                });
            } else {
                // Otherwise, select it
                hiddenInput.value = clickedValue;
                document.querySelectorAll(".urgency-circle").forEach(c => {
                    if (c.dataset.value === clickedValue) {
                        c.style.background = priorityColors[clickedValue]; 
                        c.style.color = "white";
                        c.classList.add("selected");
                    } else {
                        c.style.background = "";
                        c.style.color = "";
                        c.classList.remove("selected");
                    }
                });
            }
        });
        
        
        
        // Toggles
        addTimeToggle.addEventListener("change", ()=>{timeInput.style.display=addTimeToggle.checked?"block":"none";});
        addDescToggle.addEventListener("change", ()=>{descInput.style.display=addDescToggle.checked?"block":"none";});
        
        // Form submission
        form.addEventListener("submit", async e=>{
            e.preventDefault();
            if(!currentUser) return alert("Please log in first.");
            
            const title=document.getElementById("taskTitle").value.trim();
            const dateValue=document.getElementById("taskDueDate").value;
            const time=addTimeToggle.checked?document.getElementById("taskDueTime").value:null;
            const desc=addDescToggle.checked?descInput.value.trim():"";
            const urgency=hiddenInput.value || null; // optional
            if(!title) return;
            
            let dueDate=null;
            if(dateValue){
                const [year,month,day]=dateValue.split("-").map(Number);
                dueDate=new Date(year,month-1,day);
                if(time){ const [hours,minutes]=time.split(":").map(Number); dueDate.setHours(hours,minutes);}
            }
            
            const task={ title, dueDate: dueDate ? dueDate.toISOString() : null, urgency, desc };
            await saveTaskToFirestore(currentUser.uid, task);
            await loadUserTasks(currentUser.uid); 
            form.reset();
            hiddenInput.value=""; // reset
            timeInput.style.display="none";
            descInput.style.display="none";
        });
        
        // Render tasks
        function renderTasks(){
            taskList.innerHTML="";
            if(tasks.length===0){ taskList.innerHTML=`<p class="empty">No tasks yet. Add one above!</p>`; return; }
            const now = new Date();
            
            
            const priorityMap = { "!": 1, "!!": 2, "!!!": 3 };
            
            tasks.sort((a, b) => {
                if (sortOption.value === "urgency") {
                    const priorityOrder = { "!": 1, "!!": 2, "!!!": 3 }; 
                    const aPriority = a.urgency ? priorityOrder[a.urgency] : 0;
                    const bPriority = b.urgency ? priorityOrder[b.urgency] : 0;
                    return sortAscending ? aPriority - bPriority : bPriority - aPriority;
                } else if (sortOption.value === "dueDate") {
                    const aDate = a.dueDate ? new Date(a.dueDate) : new Date(8640000000000000); // max future
                    const bDate = b.dueDate ? new Date(b.dueDate) : new Date(8640000000000000);
                    return sortAscending ? bDate - aDate : aDate - bDate;
                }
            });
            
            
            
            tasks.forEach(task=>{
                const dueDate=task.dueDate?new Date(task.dueDate):null;
                let dueText="No due date";
                if(dueDate){
                    const diff=dueDate-now;
                    const hoursLeft=Math.max(0,Math.floor(diff/(1000*60*60)));
                    const daysLeft=Math.floor(hoursLeft/24);
                    if(daysLeft>0) dueText=`${daysLeft} day(s) left`;
                    else if(hoursLeft>0) dueText=`${hoursLeft} hour(s) left`;
                    else dueText="LATE!"
                    ;
                }
                
                const container=document.createElement("div");
                container.className="task";
                const inner=document.createElement("div");
                inner.className="task-inner";
                
                // Glow if priority selected
                if(task.urgency) inner.classList.add("glow");
                
                // Front
                // Map priorities to colors
                const priorityColors = {
                    "!": "#ff9999",
                    "!!": "#ff4d4d",
                    "!!!": "#990000"
                };
                const defaultBorderColor = "#007bff";
                
                const front=document.createElement("div");
                front.className="task-front";
                
                // Determine border color
                let borderColor = task.urgency ? priorityColors[task.urgency] : defaultBorderColor;
                front.style.border = `4px solid ${borderColor}`;
                
                const frontInfo=document.createElement("div");
                
                // Add priority badge if selected
                if(task.urgency){
                    const badge=document.createElement("div");
                    badge.className="priority-badge";
                    badge.style.background = priorityColors[task.urgency];
                    badge.textContent = task.urgency;
                    frontInfo.appendChild(badge);
                }
                
                // Add the rest of the info without overwriting badge
                const infoContent = document.createElement("div");
                infoContent.innerHTML = `
    <h3>${task.title}</h3>
    <small class="due">${dueDate?`Due: ${dueDate.toLocaleString()}`:"No due date"}</small>
    <small>${dueText}</small>
`;
                frontInfo.appendChild(infoContent);
                
                
                const doneBtn=document.createElement("button");
                doneBtn.className="delete";
                doneBtn.textContent="Done";
                doneBtn.addEventListener("click", async e=>{
                    e.stopPropagation();
                    await deleteTaskFromFirestore(currentUser.uid, task.id);
                    await loadUserTasks(currentUser.uid);
                });
                
                front.appendChild(frontInfo);
                front.appendChild(doneBtn);
                
                // Back
                const back=document.createElement("div");
                back.className="task-back";
                let backBorderColor = task.urgency ? priorityColors[task.urgency] : defaultBorderColor;
                back.style.border = `4px solid ${backBorderColor}`;
                if(task.urgency) back.classList.add("glow");
                
                
                const descSpan=document.createElement("div");
                descSpan.style.flex="1";
                descSpan.style.display="flex";
                descSpan.style.justifyContent="center";
                descSpan.style.alignItems="center";
                descSpan.innerText=task.desc||"(No description)";
                
                const editBtn=document.createElement("button");
                editBtn.className="edit-desc-btn";
                editBtn.innerText="Edit";
                editBtn.addEventListener("click", e=>{
                    e.stopPropagation();
                    editBtn.style.display="none";
                    const editArea=document.createElement("textarea");
                    editArea.value=task.desc||"";
                    editArea.style.width="90%";
                    editArea.style.minHeight="60px";
                    const saveBtn=document.createElement("button");
                    saveBtn.textContent="Save";
                    saveBtn.className="edit-desc-btn";
                    saveBtn.addEventListener("click", async ()=>{
                        const newDesc=editArea.value.trim();
                        await updateTaskDesc(currentUser.uid, task.id, newDesc);
                        await loadUserTasks(currentUser.uid);
                    });
                    back.appendChild(editArea);
                    back.appendChild(saveBtn);
                });
                
                back.appendChild(descSpan);
                back.appendChild(editBtn);
                
                inner.appendChild(front);
                inner.appendChild(back);
                inner.addEventListener("click", e=>{
                    if(["button","textarea"].includes(e.target.tagName.toLowerCase())) return;
                    inner.classList.toggle("flipped");
                });
                
                container.appendChild(inner);
                taskList.appendChild(container);
            });
        }
        
        sortOption.addEventListener("change", renderTasks);
        sortOrderBtn.addEventListener("click", ()=>{
            sortAscending=!sortAscending;
            sortOrderBtn.textContent=sortAscending?"â†‘":"â†“";
            renderTasks();
        });
        guestBtn.addEventListener("click", async () => {
            try {
                const userCredential = await signInAnonymously(auth);
                currentUser = userCredential.user;
                alert("Logged in as Guest!");
                // load tasks for this anonymous user
                loadUserTasks(currentUser.uid);
            } catch (e) {
                console.error("Anonymous login failed:", e);
                alert("Could not log in as guest.");
            }
        });
        
    </script>
</body>
</html>
